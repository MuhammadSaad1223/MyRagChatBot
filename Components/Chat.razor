@page "/chat"

@using MyRagChatBot.Models
@using MyRagChatBot.Services
@using Microsoft.AspNetCore.Components.Forms

@inject RagService RagService
@inject IJSRuntime JSRuntime
@inject IDocumentService DocumentService


<div class="container mt-4">
    <div class="card chat-container">

        <!-- Chat Header -->
        <div class="card-header chat-header bg-primary text-white">
            <h3>Chat</h3>
        </div>

        <!-- Messages -->
        <div class="card-body chat-messages" id="messagesContainer">
            @if (messages.Count == 0)
            {
                <div class="text-center text-muted py-4">
                    Start a conversation...
                </div>
            }
            else
            {
                @foreach (var msg in messages)
                {
                    <div class="message @(msg.Sender == "user" ? "user-message" : "bot-message")">
                        <div class="message-content">@msg.Message</div>
                        <small class="message-time">
                            @msg.Timestamp.ToString("HH:mm:ss")
                        </small>
                    </div>
                }
            }
        </div>

        <!-- Input -->
        <div class="card-footer chat-input p-2">
            <div class="input-group">
                <input class="form-control"
                       placeholder="Type your message..."
                       @bind="inputText"
                       @bind:event="oninput"
                       disabled="@isLoading"
                       @onkeydown="HandleEnterKey" />

                <button class="btn btn-primary"
                        @onclick="HandleSubmit"
                        disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    Send
                </button>
            </div>
        </div>
    </div>

    <!-- Debug Info -->
    <div class="mt-2 text-center">
        <small class="text-muted">
            Status: <strong>@(isLoading ? "Processing..." : "Ready")</strong> |
            Messages: <strong>@messages.Count</strong>
        </small>
    </div>

    <!-- PDF/Document File Upload -->
    <div class="mt-4">
        <InputFile OnChange="HandleFileUpload"
                   accept=".pdf,.txt,.docx"
                   multiple
                   disabled="@IsUploading" />

        <p class="mt-2">@Status</p>
    </div>
</div>

@code {
    // Chat
    private List<ChatMessage> messages = new();
    private string inputText = "";
    private bool isLoading = false;

    // Upload
    private bool IsUploading = false;
    private string Status = "No file uploaded";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ScrollToBottom();
        }
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(inputText))
            return;

        var userInput = inputText;

        messages.Add(new ChatMessage
        {
            Sender = "user",
            Message = userInput,
            Timestamp = DateTime.Now
        });

        inputText = "";
        isLoading = true;
        StateHasChanged();
        await ScrollToBottom();

        try
        {
            var response = await RagService.ProcessQuery(userInput);

            messages.Add(new ChatMessage
            {
                Sender = "bot",
                Message = response,
                Timestamp = DateTime.Now
            });
        }
        catch (Exception ex)
        {
            messages.Add(new ChatMessage
            {
                Sender = "bot",
                Message = $"Error: {ex.Message}",
                Timestamp = DateTime.Now
            });
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
            await ScrollToBottom();
        }
    }

    private async Task HandleEnterKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading)
        {
            await HandleSubmit();
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("scrollToBottom", "messagesContainer");
        }
        catch
        {
            await JSRuntime.InvokeVoidAsync(
                "eval",
                "const el=document.getElementById('messagesContainer'); if(el) el.scrollTop=el.scrollHeight;"
            );
        }
    }
    ///\\\///// PDF/File Upload \\\\\\//////
    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        IsUploading = true;
        Status = "Processing file(s)...";
        StateHasChanged();

        foreach (var file in e.GetMultipleFiles())
        {
            await DocumentService.ProcessFileAsync(file);
        }

        Status = "File(s) indexed successfully";
        IsUploading = false;
        StateHasChanged();
    }
}
